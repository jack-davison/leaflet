---
title: "Extending Leaflet"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The Leaflet JavaScript library has a plethora of [plugins](https://leafletjs.com/plugins) available that extend the functionality of the core package. We have incorporated a chosen few in the R package. It may be desirable to use plugins available outside of what are supported by this package.

The way to achieve that is by extending the Leaflet package. By extending we mean writing your own code/package that incorporate your desired leaflet plugins and hook into the leaflet package.

# Functions for extending leaflet

Certain functions have been made available for you to use in your code while extending Leaflet.

## derivePoints/derivePolygons

`derivePoints()` and `derivePolygons()` can be used to extract point or shape (polygon/line/circle/rectangle) data from a `data.frame` or a spatial object from the `{sf}` package. It tries to auto determine the latitude/longitude colnames if not specified or use user supplied column mappings.

## evalFormula

`evalFormula()` is used to evaluate a formula on a given data and return the results. e.g., `leaflet(some.data.frame) %>% addMarkers(label=~name)` internally uses `evalFormula()` to calculate the correct label values from the data using the `~name` formula.

## expandLimits

You can call `expandLimits()` to make sure that your map's view is  just enough to show every point/shape in your data. This way you don't have to determine the exact bounds for your map.

## filterNULL

Often when passing a list from R to JavaScript it is desirable to remove any null elements, and that's exactly what `filterNULL()` does.

## getMapData

`getMapData()` accesses the data object passed when calling `leaflet()` function.

## invokeMethod

`invokeMethod()` is the glue between the R code and JavaScript code. Requires a corresponding method on the JavaScript side.

# Example

Here is a small example which shows how you can integrate heatmap functionality using a [plugin](http://leaflet.github.io/Leaflet.heat/).

```{r, fig.height=4}
library(leaflet)
library(htmltools)
library(htmlwidgets)

# This tells htmlwidgets about our plugin name, version, and
# where to find the script. (There's also a stylesheet argument
# if the plugin comes with CSS files.)
heatPlugin <- htmlDependency(
  "Leaflet.heat",
  "99.99.99",
  src = c(href = "http://leaflet.github.io/Leaflet.heat/dist/"),
  script = "leaflet-heat.js"
)

# A function that takes a plugin htmlDependency object and adds
# it to the map. This ensures that however or whenever the map
# gets rendered, the plugin will be loaded into the browser.
registerPlugin <- function(map, plugin) {
  map$dependencies <- c(map$dependencies, list(plugin))
  map
}

# initialise leaflet map in R
leaflet() %>%
  addTiles() %>%
  fitBounds(min(quakes$long), min(quakes$lat), max(quakes$long), max(quakes$lat)) %>%
  # Register heatmap plugin on this map instance
  registerPlugin(heatPlugin) %>%
  # Add custom JS logic; `this` refers to the Leaflet (JS) map object.
  onRender("function(el, x, data) {
    data = HTMLWidgets.dataframeToD3(data);
    data = data.map(function(val) { return [val.lat, val.long, val.mag*100]; });
    L.heatLayer(data, {radius: 25}).addTo(this);
  }", data = quakes[c("lat", "long", "mag")])
```

